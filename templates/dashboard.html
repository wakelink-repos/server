{% extends "base.html" %}

{% block title %}Dashboard â€” WakeLink{% endblock %}

{% block content %}
<div class="dashboard-header">
    <div>
        <h1>ğŸš€ Dashboard</h1>
        <p class="welcome-text">Welcome back, <strong>{{ user.username }}</strong></p>
    </div>
    <div class="nav" style="margin: 0; animation: none;">
        <a href="/"><span>ğŸ  Home</span></a>
        <a href="/logout"><span>ğŸšª Logout</span></a>
    </div>
</div>

<div class="stats-row">
    <div class="stat-card">
        <div class="stat-icon">ğŸ“±</div>
        <div class="stat-value" data-count="{{ user.devices_count }}">{{ user.devices_count }}</div>
        <div class="stat-label">/ {{ user.devices_limit }} Devices</div>
    </div>
    <div class="stat-card">
        <div class="stat-icon">ğŸŸ¢</div>
        <div class="stat-value" data-count="{{ online_count }}">{{ online_count }}</div>
        <div class="stat-label">Online Now</div>
    </div>
    <div class="stat-card">
        <div class="stat-icon">â­</div>
        <div class="stat-value">{{ user.plan }}</div>
        <div class="stat-label">Plan</div>
    </div>
    <div class="stat-card">
        <div class="stat-icon">âš¡</div>
        <div class="stat-value" data-count="{{ system_stats.wss_connections }}">{{ system_stats.wss_connections }}</div>
        <div class="stat-label">WSS Active</div>
    </div>
</div>

<div class="section">
    <h3>ğŸ”‘ API Token</h3>
    <div class="token-display">
        <div class="token-label">Use this token to authenticate API requests</div>
        <div class="token-value" id="api-token">{{ api_token }}</div>
        <button class="copy-btn" style="margin-top: 12px;" data-copy="{{ api_token }}">ğŸ“‹ Copy Token</button>
    </div>
    <p><small><em>âš ï¸ Keep this token secure â€” it provides full access to your account</em></small></p>
</div>

<div class="section">
    <h3>ğŸ“± Your Devices</h3>
    {% if not user.devices %}
        <div class="empty-state">
            <div class="empty-state-icon">ğŸ“­</div>
            <p>No devices registered yet</p>
            <p><small>Use the API or CLI to register your first device</small></p>
        </div>
    {% else %}
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>Device ID</th>
                        <th>Status</th>
                        <th>Request Counter</th>
                        <th>Last Seen</th>
                        <th>Poll Count</th>
                        <th>Registered</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for device in user.devices %}
                    <tr>
                        <td><strong>{{ device.device_id }}</strong></td>
                        <td>
                            {% if device.online %}
                                <span class="status status-online"><span class="status-dot"></span> Online</span>
                            {% else %}
                                <span class="status status-offline"><span class="status-dot"></span> Offline</span>
                            {% endif %}
                        </td>
                        <td><code>{{ device.last_request_counter or 0 }}</code></td>
                        <td>{{ device.last_seen.strftime('%Y-%m-%d %H:%M') if device.last_seen else 'â€”' }}</td>
                        <td>{{ device.poll_count }}</td>
                        <td>{{ device.added.strftime('%Y-%m-%d') if device.added else 'â€”' }}</td>
                        <td>
                            <button class="delete-btn" onclick="deleteDevice('{{ device.device_id }}')">ğŸ—‘ï¸ Delete</button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    {% endif %}
</div>

<div class="section">
    <h3>ğŸ”§ Quick API Reference</h3>
    <div class="api-section">
        <h4>Register Device</h4>
        <div class="token" id="register-cmd">curl -X POST "{{ base_url }}/api/register_device" \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer {{ api_token }}" \
  -d '{"device_id": "my_esp32"}'</div>
        <button class="copy-btn" data-copy='curl -X POST "{{ base_url }}/api/register_device" -H "Content-Type: application/json" -H "Authorization: Bearer {{ api_token }}" -d '\''{"device_id": "my_esp32"}'\'''>ğŸ“‹ Copy</button>

        <h4>List Devices</h4>
        <div class="token" id="devices-cmd">curl -X GET "{{ base_url }}/api/devices" \
  -H "Authorization: Bearer {{ api_token }}"</div>
        <button class="copy-btn" data-copy='curl -X GET "{{ base_url }}/api/devices" -H "Authorization: Bearer {{ api_token }}"'>ğŸ“‹ Copy</button>

        <h4>Delete Device</h4>
        <div class="token" id="delete-cmd">curl -X POST "{{ base_url }}/api/delete_device" \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer {{ api_token }}" \
  -d '{"device_id": "DEVICE_ID"}'</div>
        <button class="copy-btn" data-copy='curl -X POST "{{ base_url }}/api/delete_device" -H "Content-Type: application/json" -H "Authorization: Bearer {{ api_token }}" -d '\''{"device_id": "DEVICE_ID"}'\'''>ğŸ“‹ Copy</button>
    </div>
</div>

<div class="section">
    <h3>ğŸ“Š System Status</h3>
    <div class="stats-row" style="margin: 0;">
        <div class="stat-card">
            <div class="stat-value" data-count="{{ system_stats.online_devices }}">{{ system_stats.online_devices }}</div>
            <div class="stat-label">Online Devices</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" data-count="{{ system_stats.wss_connections }}">{{ system_stats.wss_connections }}</div>
            <div class="stat-label">WSS Connections</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" data-count="{{ system_stats.total_devices }}">{{ system_stats.total_devices }}</div>
            <div class="stat-label">Total Devices</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" data-count="{{ system_stats.total_users }}">{{ system_stats.total_users }}</div>
            <div class="stat-label">Total Users</div>
        </div>
    </div>
    <p style="text-align: center; margin-top: 16px;"><small>Server Time: {{ server_time }}</small></p>
</div>
{% endblock %}

{% block scripts %}
<script>
    async function deleteDevice(deviceId) {
        if (!confirm(`Delete device "${deviceId}"?`)) return;

        try {
            const response = await fetch('/dashboard/delete_device', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ device_id: deviceId }),
                credentials: 'include'
            });

            if (response.ok) {
                WakeLink.showToast('Device deleted successfully', 'success');
                setTimeout(() => location.reload(), 1000);
            } else {
                const error = await response.json();
                WakeLink.showToast('Error: ' + (error.detail || 'Unknown error'), 'error');
            }
        } catch (error) {
            WakeLink.showToast('Error: ' + error.message, 'error');
        }
    }

    // Auto-refresh every 30s
    setTimeout(() => location.reload(), 30000);
</script>
{% endblock %}